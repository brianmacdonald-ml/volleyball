
var seasonDisplay = undefined;
var selectedGrouping = undefined;

function step1ResultsSetup() {
	var teamId = $("#teamSelect").val();
	updateSeasonDropDown(teamId);
	createResults("You've selected: " + $('#teamId' + teamId).text(), "I want to change this team", 1);
}

function step2ResultsSetup() {
	var seasonId = $("#seasonSelect").val();
	updateEventSelector(seasonId);
	createResults("You've selected: " + $('#seasonId' + seasonId).text(), "I want to change this season", 2);
}

function step3ResultsSetup() {
	createResults("You've selected: " + selectedGrouping.name, "I want to change this event", 3);
}

$(document).ready(function () {
	
	updateTeamDropDown();
	$("#teamSelect").change(step1Complete);
	$("#seasonSelect").change(step2Complete);
	
    registerStepComplete(1, step1Complete);
    registerStepComplete(2, step2Complete);
    registerStepComplete(3, step3Complete);
    registerStepComplete(4, step4Complete);
});

/**************
Step Complete functions
****************/
function step1Complete() {
	// Check to see if inputs are valid. If not, return and skip the rest of the stuff in this method.
	if (!validateNotDefaultSelected("teamSelect", "This field is required. Please select a team.")) return;
	stepIsComplete(1, step1ResultsSetup);
}

function step2Complete() {
	if (!validateNotDefaultSelected("seasonSelect", "This field is required. Please select a season.")) return;
	stepIsComplete(2, step2ResultsSetup);
}

function step3Complete() {
	stepIsComplete(3, step3ResultsSetup);
}

function step4Complete() {
	$("#associateVideoToGameForm").append("<input type='hidden' name='eventSelect' value='" + selectedGrouping.id + "'/>");
	$("#associateVideoToGameForm").submit();
}

/**************
  Form Setup functions
 ****************/
function updateTeamDropDown() {
	for (team in teams) {
		var teamObject = teams[team];
		if (!teamObject.autogenerated) {
			$("#teamSelect").append(createOptionElement(teamObject.name, teamObject.id, "teamId"));
		}
	}
}

function updateSeasonDropDown(teamId) {
	teamId = Number(teamId);
	emptySelectBox("seasonSelect");
	for (season in seasons) {
		var seasonObject = seasons[season];
		if (seasonObject.teamId == teamId) {
			$("#seasonSelect").append(createOptionElement(seasonObject.name, seasonObject.id, "seasonId"));
		}
	}
}

function updateEventSelector(seasonId) {
	$.get(
		URL, 
		{
			action: 'seasonData',
			seasonId: seasonId
		},
		function (data, textStatus) {
			// Reset a few things to their original state
			$('#dynamicEventSelect').html("");
			$('#selectEvent').remove();
			showEventSelectDialog.eventDialog = undefined;
			
			// Add in the new data that will be picked up by SeasonDisplay
			$('#dynamicEventSelect').append(data);
			seasonDisplay = new SeasonDisplay("#selectEvent", eventGroupings, {radioButtonMode: true});
			$("#step3Loading").html("").append($("<a href='#'>Click this link to select an event</a>").click(showEventSelectDialog));
			showEventSelectDialog();
		}
	);
}

function showEventSelectDialog(jsEvent) {
	if (jsEvent != undefined) {
		jsEvent.preventDefault();
		jsEvent.stopPropagation();
	}
	
	if (showEventSelectDialog.eventDialog == undefined) {
		showEventSelectDialog.eventDialog = $("#selectEvent").dialog({ 
			closeText: '',
			modal: 'true',
		    height: '500',
		    width: '700',
			buttons: { 
				"Use this event": function() { 
					var selectedId = $("#selectEvent input:checked").val();
					if (selectedId != undefined) {
						selectedGrouping = eventGroupings[selectedId];
						
						$(this).dialog("close");
						
						step3Complete();
					}
				},
				"Cancel": function() { $(this).dialog("close"); } 
			}
		});
	} else {
		showEventSelectDialog.eventDialog.dialog("open");
	}
	
}

function emptySelectBox(selectBoxId) {
	var firstChild = $("#" + selectBoxId).children()[0];
	$("#" + selectBoxId).empty();
	$("#" + selectBoxId).append(firstChild);
}

function createOptionElement(text, value, id) {
	return $("<option>").attr({"value": value, "id" : id + value}).append(text);
}
